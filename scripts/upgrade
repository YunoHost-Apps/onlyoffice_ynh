#!/bin/bash

#=================================================
# IMPORT GENERIC HELPERS
#=================================================

source _common.sh
source /usr/share/yunohost/helpers

#=================================================
# STOP SYSTEMD SERVICE
#=================================================
ynh_script_progression "Stopping $app's systemd service..."

# IMPORTANT: This is not optional, cause this run the routine 
# prepare4shutdown and save all the current opened document. 
ynh_systemctl --service="$app" --action="stop"

#=================================================
# ENSURE DOWNWARD COMPATIBILITY
#=================================================
ynh_script_progression "Ensuring downward compatibility..."

ynh_app_setting_set_default --key=allowed_urls --value="https://${nextclouddomain:-}"
init_settings

# Remove old install made by .deb
if dpkg-query --show onlyoffice-documentserver &> /dev/null; then

    documentserver-prepare4shutdown.sh
    ynh_backup_if_checksum_is_different --file="/etc/onlyoffice/documentserver/default.json"
    ynh_backup_if_checksum_is_different --file="/etc/onlyoffice/documentserver/local.json"
    _ynh_apt purge onlyoffice-documentserver
    ynh_hide_info ynh_safe_rm "/etc/apt/sources.list.d/onlyoffice.list"
    ynh_hide_info ynh_safe_rm "/etc/apt/sources.list.d/nodesource.list"
    ynh_hide_info ynh_safe_rm "/var/lib/dpkg/info/onlyoffice-documentserver.prerm"
    ynh_hide_info ynh_safe_rm "/var/lib/onlyoffice"
    ynh_hide_info ynh_safe_rm "/etc/onlyoffice"

    for service in "ds-converter" "ds-docservice" "ds-metrics"; do
        if yunohost service status "$service" >/dev/null 2>&1
        then
            yunohost service remove "$service"
        fi
    done
fi

#=================================================
# DOWNLOAD, CHECK AND UNPACK SOURCE
#=================================================
ynh_script_progression "Upgrading OnlyOffice..."

setup_sources

#=================================================
# COMPILE ONLYOFFICE
#=================================================
if [[ "$official_build" == "1" ]] ; then
    ynh_script_progression "Compiling $app..."

    compile
fi

#=================================================
# SETUP RABBIT MQ VHOST
#=================================================
ynh_script_progression "Configuring rabbitmq vhost $app..."

ynh_rabbitmq_setup_vhost

#=================================================
# SETUP REDIS DB
#=================================================
ynh_script_progression "Configuring redis db..."

configure_redis

#=================================================
# UPDATE A CONFIG FILE
#=================================================
ynh_script_progression "Updating a configuration file..."

ynh_config_add --template="local.json" --destination="$conf_dir/local.json"
chmod 400 "$conf_dir/local.json"
chown "$app:$app" "$conf_dir/local.json"

#=================================================
# REAPPLY SYSTEM CONFIGURATION
#=================================================
ynh_script_progression "Upgrading system configurations related to $app..."

apply_system_config

#=================================================
# REGENERATE FONTS AND FLUSH CACHE
#=================================================
ynh_script_progression "Generating fonts and flushing cache..."

ynh_hide_warnings $install_dir/bin/documentserver-generate-allfonts.sh

#=================================================
# START SERVICES
#=================================================

ynh_systemctl --action=restart --service="$app" 

#=================================================
# END OF SCRIPT
#=================================================

ynh_script_progression "Upgrade of $app completed"
