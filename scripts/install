#!/bin/bash

#=================================================
# IMPORT GENERIC HELPERS
#=================================================

source _common.sh
source /usr/share/yunohost/helpers

#=================================================
# INITIALIZE AND STORE SETTINGS
#=================================================

init_settings

#=================================================
# DOWNLOAD, CHECK AND UNPACK SOURCE
#=================================================
ynh_script_progression "Setting up source files..."

setup_sources

#=================================================
# COMPILE ONLYOFFICE
#=================================================

if [[ "$rebuild_without_limitations" == "1" ]] ; then
    ynh_script_progression "Compiling $app..."

    compile
fi

#=================================================
# SETUP RABBIT MQ VHOST
#=================================================
ynh_script_progression "Configuring rabbitmq vhost $app..."

ynh_rabbitmq_setup_vhost

#=================================================
# SETUP REDIS DB
#=================================================
ynh_script_progression "Configuring redis db..."

configure_redis

#=================================================
# APP INITIAL CONFIGURATION
#=================================================
ynh_script_progression "Adding $app's configuration files..."

ynh_config_add --template="local.json" --destination="$conf_dir/local.json"
chmod 400 "$conf_dir/local.json"
chown "$app:$app" "$conf_dir/local.json"

#=================================================
# SETUP DATABASE
#=================================================
ynh_script_progression "Populating postgresql database $app..."

db_dump="$install_dir/documentserver/server/schema/postgresql/createdb.sql"
echo "alter table doc_changes owner to $app;" >> $db_dump
echo "alter table task_result owner to $app;" >> $db_dump
ynh_psql_db_shell $app < "$install_dir/documentserver/server/schema/postgresql/createdb.sql"

#=================================================
# SYSTEM CONFIGURATION
#=================================================
ynh_script_progression "Adding system configurations related to $app..."

apply_system_config

#=================================================
# REGENERATE FONTS AND FLUSH CACHE
#=================================================
ynh_script_progression "Generating fonts and flushing cache..."

ynh_hide_warnings $install_dir/bin/documentserver-generate-allfonts.sh

#=================================================
# START SERVICES
#=================================================

ynh_systemctl --action=start --service="$app" 

#=================================================
# END OF SCRIPT
#=================================================

ynh_script_progression "Installation of $app completed"
